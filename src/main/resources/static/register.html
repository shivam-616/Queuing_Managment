<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Queue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

<div class="w-full max-w-lg bg-white p-8 sm:p-12 rounded-2xl shadow-xl">

    <header class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100">
            <svg class="h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
        </div>
        <h1 class="text-3xl font-bold mt-4 text-gray-900">Join Queue</h1>
        <p class="mt-2 text-slate-600">You are joining: <strong id="queueName" class="text-indigo-600"></strong></p>
    </header>

    <main class="mt-10">
        <form id="registerForm" class="hidden">
            <div id="dynamic-fields" class="space-y-6">
            </div>
            <button type="submit" class="mt-8 w-full flex justify-center items-center gap-2 py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <span>Confirm and Join Queue</span>
            </button>
        </form>

        <div id="statusView" class="hidden text-center">
            <div id="result" class="mb-6"></div>

            <div id="statusCard" class="bg-slate-50 border border-slate-200 rounded-lg p-6 transition-all duration-300">
                <div id="position-container">
                    <p class="text-sm font-medium text-slate-500">Your current status</p>
                    <div id="position" class="my-2 text-2xl font-bold text-indigo-600">
                        Connecting to queue...
                    </div>
                    <p id="waitTime" class="text-sm text-slate-500"></p>
                </div>
                <div id="notification"></div>
            </div>
        </div>
    </main>
</div>


<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    const params = new URLSearchParams(window.location.search);
    const queueId = params.get('id');
    const queueName = params.get('name');
    const userDetails = params.get('details');

    let stompClient = null;
    let myQueueEntry = null;

    document.getElementById('queueName').textContent = queueName || 'Unnamed Queue';
    const notificationSound = new Audio('notification.mp3');

    function connectSocket() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log("Connected to WebSocket");

            // Subscribe to general queue updates
            stompClient.subscribe(`/topic/queue/${queueId}`, (message) => {
                const queueUpdate = JSON.parse(message.body);
                // The backend now sends an object with 'entries' and 'estimatedWaitTime'
                updateQueuePosition(queueUpdate.entries, queueUpdate.estimatedWaitTime);
            });

            // Subscribe to specific "you are called" notifications
            if (myQueueEntry && myQueueEntry.id) {
                stompClient.subscribe(`/topic/called/${queueId}/${myQueueEntry.id}`, function (message) {
                    const calledEntry = JSON.parse(message.body);
                    if (calledEntry.id === myQueueEntry.id) {
                        notificationSound.play();
                        const statusCard = document.getElementById("statusCard");
                        const notificationDiv = document.getElementById("notification");
                        document.getElementById("position-container").classList.add('hidden');
                        notificationDiv.innerHTML = `
                            <p class="text-sm font-medium text-green-600">It's your turn!</p>
                            <p class="my-2 text-3xl font-bold text-green-700">Please Proceed</p>
                            <p class="text-slate-500">Your Number: ${calledEntry.queueNumber}</p>
                        `;
                        statusCard.classList.remove('bg-slate-50', 'border-slate-200');
                        statusCard.classList.add('bg-green-100', 'border-green-300');
                    }
                });
            }

            // Fetch the initial state right after connecting
            fetchInitialQueueState();
        });
    }

    function fetchInitialQueueState() {
        fetch(`/api/queue/${queueId}/all`)
            .then(res => res.json())
            .then(queue => {
                // We pass a dummy wait time for the initial fetch
                updateQueuePosition(queue, -1);
            });
    }

    function updateQueuePosition(queue, estimatedWaitTime) {
        if (!myQueueEntry) return;

        const waitingList = queue.filter(user => user.status === "waiting");
        const myEntry = waitingList.find(user => user.id === myQueueEntry.id);
        const positionDiv = document.getElementById("position");
        const waitTimeDiv = document.getElementById("waitTime");

        if (myEntry) {
            const peopleAhead = waitingList.filter(e => e.queueNumber < myEntry.queueNumber).length;
            positionDiv.innerHTML = `<span class="text-5xl">${peopleAhead}</span><br>people ahead of you`;

            if (estimatedWaitTime >= 0) {
                waitTimeDiv.innerText = `Estimated wait: ${estimatedWaitTime} minutes`;
            } else {
                waitTimeDiv.innerText = 'Calculating estimated wait time...';
            }
        } else {
            const myCalledEntry = queue.find(user => user.id === myQueueEntry.id);
            if (myCalledEntry && myCalledEntry.status === 'called') {
                 positionDiv.innerText = "You have been served.";
                 waitTimeDiv.innerText = "";
            } else {
                 positionDiv.innerText = "The queue has been reset.";
                 waitTimeDiv.innerText = "";
            }
        }
    }

    if (userDetails) {
        document.getElementById('registerForm').classList.remove('hidden');
        const fieldsContainer = document.getElementById('dynamic-fields');
        const fields = userDetails.split(',').map(s => s.trim());

        fields.forEach(field => {
            const fieldName = field.toLowerCase().replace(/\s+/g, '');
            const div = document.createElement('div');
            div.innerHTML = `
                <label for="${fieldName}" class="block text-sm font-medium text-slate-700">${field}</label>
                <div class="mt-1 relative">
                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                    </div>
                    <input type="text" id="${fieldName}" name="${fieldName}" class="block w-full pl-10 pr-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-slate-900 placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500" required>
                </div>
            `;
            fieldsContainer.appendChild(div);
        });
    }

    document.getElementById("registerForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const details = Object.fromEntries(new FormData(e.target).entries());

        fetch(`/api/queue/${queueId}/create`, {
            method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ details })
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => {
                    // Use the actual server message if available
                    throw new Error(err.message || 'An unknown error occurred.');
                });
            }
            return res.json();
        })
        .then(data => {
            myQueueEntry = data;
            document.getElementById("registerForm").classList.add('hidden');
            document.getElementById("statusView").classList.remove('hidden');
            document.getElementById("result").innerHTML = `<p class="text-green-600 font-semibold text-lg">✅ Success! Your queue number is <span class="font-bold text-2xl">${data.queueNumber}</span></p>`;
            connectSocket();
        })
        .catch(err => {
            // This logic ensures the error message is always visible
            const statusView = document.getElementById("statusView");
            const resultDiv = document.getElementById("result");
            const form = document.getElementById("registerForm");

            statusView.classList.remove('hidden');
            form.classList.add('hidden'); // Hide the form on error too
            resultDiv.innerHTML = `<p class="text-red-600 font-semibold">❌ Error: ${err.message}</p>`;
        });
    });
</script>
</body>
</html>