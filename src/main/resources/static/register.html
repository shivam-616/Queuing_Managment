<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Join Queue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
<div class="w-full max-w-md bg-white p-8 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-2 text-center text-gray-800">Join Queue: <span id="queueName"></span></h2>

    <form id="registerForm" class="hidden">
        <!-- Dynamic fields will be inserted here -->
        <div id="dynamic-fields" class="mb-4"></div>
        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
            Join Queue
        </button>
    </form>

    <div id="result" class="mt-4 text-center"></div>
    <div id="position" class="mt-2 text-center font-semibold text-blue-600"></div>
    <div id="notification" class="mt-4 text-center text-2xl font-bold text-green-600"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    const params = new URLSearchParams(window.location.search);
    const queueId = params.get('id');
    const queueName = params.get('name');
    const userDetails = params.get('details');

    let stompClient = null;
    let myQueueEntry = null;

    document.getElementById('queueName').textContent = queueName || 'Unnamed Queue';

    function connectSocket() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log("Connected to WebSocket");
            stompClient.subscribe(`/topic/queue/${queueId}`, function (message) {
                const queue = JSON.parse(message.body);
                updateQueuePosition(queue);
            });
            stompClient.subscribe(`/topic/called/${queueId}/${myQueueEntry?.id}`, function (message) {
                const calledEntry = JSON.parse(message.body);
                if (calledEntry.id === myQueueEntry.id) {
                     document.getElementById("notification").innerText = `üéâ It's your turn! Your Queue No is ${calledEntry.queueNumber}`;
                }
            });
        });
    }

    function updateQueuePosition(queue) {
        if (!myQueueEntry) return;

        const waitingList = queue.filter(user => user.status === "waiting");
        const myEntry = waitingList.find(user => user.id === myQueueEntry.id);

        if (myEntry) {
            const peopleAhead = waitingList.filter(e => e.queueNumber < myEntry.queueNumber).length;
            document.getElementById("position").innerText = `People ahead of you: ${peopleAhead}`;
        } else {
             const myCalledEntry = queue.find(user => user.id === myQueueEntry.id && user.status === 'called');
            if(!myCalledEntry){
                document.getElementById("position").innerText = "You have been served.";
            }
        }
    }

    if (userDetails) {
        document.getElementById('registerForm').classList.remove('hidden');
        const fieldsContainer = document.getElementById('dynamic-fields');
        const fields = userDetails.split(',').map(s => s.trim());

        fields.forEach(field => {
            const fieldName = field.toLowerCase().replace(/\s+/g, '');
            const div = document.createElement('div');
            div.className = 'mb-4';
            div.innerHTML = `
                <label for="${fieldName}" class="block text-gray-700 text-sm font-bold mb-2">${field}:</label>
                <input type="text" id="${fieldName}" name="${fieldName}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            `;
            fieldsContainer.appendChild(div);
        });
    }

    document.getElementById("registerForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const details = Object.fromEntries(formData.entries());

        fetch(`/api/queue/${queueId}/create`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ details })
        })
        .then(res => res.json())
        .then(data => {
            myQueueEntry = data;
            document.getElementById("registerForm").classList.add('hidden');
            document.getElementById("result").innerHTML = `<p class="text-green-600 font-semibold">‚úÖ You have joined the queue. Your queue number is ${data.queueNumber}</p>`;
            connectSocket();
        })
        .catch(err => {
            document.getElementById("result").innerHTML = `<p style="color:red;">‚ùå Error: ${err.message}</p>`;
        });
    });
</script>
</body>
</html>

